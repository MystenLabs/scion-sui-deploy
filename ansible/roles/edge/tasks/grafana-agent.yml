---
- name: Copy systemd service file
  copy:
    src: "{{ grafana_agent_systemd_path }}"
    dest: /etc/systemd/system/grafana-agent.service
    owner: root
    group: root
    mode: '0644'
  become: yes
  tags:
    - metrics

- name: Ensure /etc/grafana directory exists
  file:
    path: /etc/grafana
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes
  tags:
    - metrics

- name: Copy configuration file
  copy:
    src: "{{ grafana_agent_config_path }}"
    dest: /etc/grafana/agent-config.yaml
    owner: root
    group: root
    mode: '0644'
  become: yes
  tags:
    - metrics

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  become: yes
  tags:
    - metrics

- name: Enable and start the new service
  systemd:
    name: "grafana-agent"
    enabled: yes
    state: started
  become: yes
  tags:
    - metrics
